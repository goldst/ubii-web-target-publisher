<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Ubi-Interact Target Publisher</title>
</head>

<body>
    <h1>Ubi-Interact Target Publisher</h1>

    <style>
        html,
        body {
            font-family: Arial, Helvetica, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control,
        .control>*:not(button):not(span) {
            display: grid;
            column-gap: 10px;
            row-gap: 10px;
        }

        .control {
            padding: 10px;
            border: 2px solid black;
            border-radius: 5px;
            grid-template-columns: 1fr 1fr;
            max-width: 750px;
        }

        .control>*:not(button) {
            grid-template-columns: 2fr 3fr;
        }

        button {
            border: 1px solid black;
            background-color: lightgray;
            border-radius: 3px;
        }

        @media screen and (max-width: 600px) {
            .control {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <div class="control">
        <label>
            <span>Service URL</span>
            <input type="text" class="service-url" placeholder="http://localhost:8102/services">
        </label>
        <label>
            <span>Topic data URL</span>
            <input type="text" class="topic-data-url" placeholder="ws://localhost:8104/topicdata">
        </label>
        <label>
            <span>Topic</span>
            <input type="text" class="topic" placeholder="/avatar/ik_target">
        </label>
        <label>
            <span>Use ClientId prefix</span>
            <input type="checkbox" class="device-prefix">
        </label>
        <label>
            <span>Publish interval (ms)</span>
            <input type="number" class="publish-interval" value="30">
        </label>
        <label>
            Input source
            <select>
                <option value="0">Rotate left hand</option>
                <option value="1">Device input (to do)</option>
                <option value="2">Running animation (to do)</option>
            </select>
        </label>
        <span></span>
        <span></span>
        <button onClick="start()" class="start">Start</button>
        <button onClick="stop()">Stop</button>
    </div>

    <h2>Last published targets</h2>
    <div class="control">
        <span><code>HEAD</code></span>
        <div class="target-HEAD">(no value)</div>

        <span><code>VIEWING_DIRECTION</code></span>
        <div class="target-VIEWING_DIRECTION">(no value)</div>

        <span><code>HIP</code></span>
        <div class="target-HIP">(no value)</div>

        <span><code>HAND_LEFT</code></span>
        <div class="target-HAND_LEFT">(no value)</div>

        <span><code>HAND_RIGHT</code></span>
        <div class="target-HAND_RIGHT">(no value)</div>

        <span><code>FOOT_LEFT</code></span>
        <div class="target-FOOT_LEFT">(no value)</div>

        <span><code>FOOT_RIGHT</code></span>
        <div class="target-FOOT_RIGHT">(no value)</div>
    </div>

    <footer style="margin-top: 50px; max-width: 750px; font-style: italic; text-align: center;">
        This interface demonstrates the use of the <a
            href="https://www.gihub.com/goldst/ubii-web-target-publisher">Ubi-Interact target publisher for web
            browsers</a>. The target publisher can be used to send tracked user pose data. This is a necessary step in
        physical embodiment scenarios, where users are represented virtually through a physical avatar.
    </footer>

    <script src="./bundle.js"></script>
    <script>
        let publisher;
        const serviceURLInput = document.querySelector('.service-url');
        const topicDataURLInput = document.querySelector('.topic-data-url');
        const topicInput = document.querySelector('.topic');
        const devicePrefixCheckbox = document.querySelector('.device-prefix');
        const publishIntervalInput = document.querySelector('.publish-interval');
        const targetLogElements = {
            HEAD: document.querySelector('.target-HEAD'),
            VIEWING_DIRECTION: document.querySelector('.target-VIEWING_DIRECTION'),
            HIP: document.querySelector('.target-HIP'),
            HAND_LEFT: document.querySelector('.target-HAND_LEFT'),
            HAND_RIGHT: document.querySelector('.target-HAND_RIGHT'),
            FOOT_LEFT: document.querySelector('.target-FOOT_LEFT'),
            FOOT_RIGHT: document.querySelector('.target-FOOT_RIGHT')
        }

        const buttonStart = document.querySelector('.start');

        function start() {
            const urlServices = serviceURLInput.value || 'http://localhost:8102/services';
            const urlTopicData = topicDataURLInput.value || 'ws://localhost:8104/topicdata';
            const topic = topicInput.value || '/avatar/ik_target';
            const useDevicePrefix = serviceURLInput.checked;
            const publishInterval = parseInt(publishIntervalInput.value || '30');

            buttonStart.style.backgroundColor = 'green';

            publisher = new UbiiWebTargetPublisher.Publisher(
                urlServices,
                urlTopicData,
                topic,
                useDevicePrefix,
                publishInterval,
                logTargets(circleLeftHand)
            );
        }

        function stop() {
            buttonStart.style.backgroundColor = 'lightgray';

            publisher?.stop();
        }

        function logTargets(fn) {
            return i => {
                const result = fn(i);

                result.forEach(element => {
                    targetLogElements[element.id].innerHTML = `
                        <code>pos x</code><code>${element.pose.position.x.toFixed(9)}</code>
                        <code>pos y</code><code>${element.pose.position.y.toFixed(9)}</code>
                        <code>pos z</code><code>${element.pose.position.z.toFixed(9)}</code>
                        <code>quat x</code><code>${element.pose.quaternion.x.toFixed(9)}</code>
                        <code>quat y</code><code>${element.pose.quaternion.y.toFixed(9)}</code>
                        <code>quat z</code><code>${element.pose.quaternion.z.toFixed(9)}</code>
                        <code>quat w</code><code>${element.pose.quaternion.w.toFixed(9)}</code>
                    `;
                });

                return result;
            }
        }

        function circleLeftHand(i) {
            return [
                {
                    id: 'HEAD',
                    pose: {
                        position: {
                            x: -0.012127973139286,
                            y: 1.60195863246918,
                            z: 0.0515786409378052
                        },
                        quaternion: {
                            x: -0.027315977960825,
                            y: 0.0505646392703056,
                            z: 0.00574674224480987,
                            w: 0.998330891132355
                        }
                    }
                },
                {
                    id: 'VIEWING_DIRECTION',
                    pose: {
                        position: {
                            x: 0.0885185226798058,
                            y: 1.65708041191101,
                            z: 1.04497265815735
                        },
                        quaternion: {
                            x: -0.027315977960825,
                            y: 0.0505646392703056,
                            z: 0.00574674224480987,
                            w: 0.998330891132355
                        }
                    }
                },
                {
                    id: 'HIP',
                    pose: {
                        position: {
                            x: -0.000938805053010583,
                            y: 1.00233638286591,
                            z: 0.00923597812652588
                        },
                        quaternion: {
                            x: -0.0188162010163069,
                            y: -0.0110604939982295,
                            z: 0.0043814443051815,
                            w: 0.999752223491669
                        }
                    }
                },
                {
                    id: 'HAND_LEFT',
                    pose: {
                        position: {
                            x: -0.28404825925827,
                            y: 0.868937909603119 + 0.25 * Math.sin(0.5 * i),
                            z: -0.0312468409538269 + 0.25 * Math.cos(0.5 * i)
                        },
                        quaternion: {
                            x: -0.0548369660973549,
                            y: -0.0395688787102699,
                            z: 0.612994313240051,
                            w: 0.787188410758972
                        }
                    }
                },
                {
                    id: 'HAND_RIGHT',
                    pose: {
                        position: {
                            x: 0.267915040254593,
                            y: 0.87404203414917,
                            z: -0.0829932689666748
                        },
                        quaternion: {
                            x: -0.0861630737781525,
                            y: 0.130851477384567,
                            z: -0.607899904251099,
                            w: 0.778403460979462
                        }
                    }
                },
                {
                    id: 'FOOT_LEFT',
                    pose: {
                        position: {
                            x: -0.0979599729180336,
                            y: 0.111964344978333,
                            z: -0.0348696112632751
                        },
                        quaternion: {
                            x: 0.0114378817379475,
                            y: -0.0597983151674271,
                            z: -0.00311729917302728,
                            w: 0.998140215873718
                        }
                    }
                },
                {
                    id: 'FOOT_RIGHT',
                    pose: {
                        position: {
                            x: 0.13067464530468,
                            y: 0.113616228103638,
                            z: -0.033577561378479
                        },
                        quaternion: {
                            x: 0.00896886177361012,
                            y: 0.22054997086525,
                            z: 0.0105661768466234,
                            w: 0.975277483463287
                        }
                    }
                },
            ];
        }
    </script>

</body>

</html>